@model IEnumerable<YastCleaner.Web.ViewModels.PedidosTemporalViewModel>

@{
    ViewData["Title"] = "Registrar Pedido";
    double totalPagar = ViewBag.Importe ?? 0;
    double montoAdelanto = ViewBag.MontoAdelanto ?? 0;
    double saldoPendiente = totalPagar - montoAdelanto;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Temporal.css" />
    <link rel="stylesheet" href="~/css/RegistrarPedido.css" />
}

<div class="registro-container">
    <!-- Header de la página -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-clipboard-check me-3"></i>
            Registrar Pedido
        </h1>
        <div class="carrito-estado">
            <span class="badge-estado badge-activo">@Model.Count() servicios en carrito</span>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert-custom alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            @TempData["Error"]
        </div>
    }

    <div class="registro-grid">
        <!-- Formulario de Registro -->
        <div class="formulario-pedido">
            <div class="formulario-header">
                <h3><i class="fas fa-edit"></i> Información del Pedido</h3>
            </div>
            <div class="formulario-body">
                <form asp-controller="Pedido" asp-action="RegistrarPedido" method="post" id="pedidoForm" data-total="@totalPagar">
                    <div class="form-group">
                        <label for="fecha" class="form-label">Fecha y Hora</label>
                        <input type="datetime-local" id="fecha" name="fecha" class="form-control"
                               value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                        <div class="form-text">Seleccione la fecha y hora del pedido</div>
                    </div>

                    <div class="form-group">
                        <label for="cliente" class="form-label">Cliente</label>
                        <div class="cliente-input-container">
                            <input type="text" id="cliente" class="form-control" autocomplete="off"
                                   placeholder="Ingrese el nombre del cliente..." />
                            <input type="hidden" id="clienteId" name="clienteId" />
                            <div class="sugerencias-container" id="sugerencias"></div>
                        </div>
                        <div class="form-text">Elija el cliente para el pedido</div>
                    </div>

                    <div class="form-group">
                        <label for="metodoPago" class="form-label">Método de Pago</label>
                        <select id="metodoPago" name="metodoPago" asp-items="@ViewBag.MetodosPago" class="form-select" required>
                            <option value="">Seleccione un método de pago</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="montoAdelanto" class="form-label">Monto Adelantado</label>
                        <div class="input-group">
                            <span class="input-group-text">S/</span>
                            <input type="number" id="montoAdelanto" name="montoAdelanto"
                                   class="form-control" step="0.01" min="0" max="@totalPagar"
                                   value="@montoAdelanto" oninput="calcularSaldo()" />
                        </div>
                        <div class="form-text">Máximo permitido: S/ @totalPagar.ToString("N2")</div>
                    </div>

                    <!-- Resumen de Pago -->
                    <div class="resumen-pago">
                        <h5 class="mb-3"><i class="fas fa-receipt me-2"></i>Resumen de Pago</h5>
                        <div class="resumen-linea">
                            <span>Total Pedido:</span>
                            <span class="fw-bold">S/ @totalPagar.ToString("N2")</span>
                        </div>
                        <div class="resumen-linea">
                            <span>Monto Adelantado:</span>
                            <span id="adelantoMostrado" class="fw-bold">S/ @montoAdelanto.ToString("N2")</span>
                        </div>
                        <div class="resumen-linea">
                            <span class="fw-bold">Saldo Pendiente:</span>
                            <span id="saldoPendiente" class="fw-bold text-success">S/ @saldoPendiente.ToString("N2")</span>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="acciones-formulario">
                        <div class="acciones-grupo">
                            <a asp-controller="Servicio" asp-action="Servicios" class="btn-formulario btn-agregar-servicio">
                                <i class="fas fa-plus-circle"></i> Agregar Servicio
                            </a>
                            <a asp-controller="Pedido" asp-action="Temporal" class="btn-formulario btn-modificar-carrito">
                                <i class="fas fa-edit"></i> Modificar Carrito
                            </a>
                            <a asp-controller="Cliente" asp-action="Registrar" class="btn-formulario btn-registrar-cliente">
                                <i class="fas fa-user-plus"></i> Registrar Cliente
                            </a>
                        </div>
                        <button type="submit" class="btn-formulario btn-registrar-pedido">
                            <i class="fas fa-check-circle"></i> Registrar Pedido
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Detalles del Carrito -->
        <div class="detalles-carrito">
            <div class="detalles-header">
                <h3><i class="fas fa-shopping-cart"></i> Detalles del Carrito</h3>
            </div>
            <div class="formulario-body">
                @if (Model.Any())
                {
                    <div class="tabla-contenido">
                        <table class="tabla-detalles">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Servicio</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.Id</td>
                                        <td>
                                            <div class="servicio-info">
                                                <div class="servicio-nombre">@item.Nombre</div>
                                            </div>
                                        </td>
                                        <td class="text-center">@item.Cantidad</td>
                                        <td class="text-end precio-unitario">S/ @item.Precio.ToString("N2")</td>
                                        <td class="text-end importe-total">S/ @item.Importe.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="resumen-carrito">
                        <div class="resumen-item">
                            <span class="resumen-valor">@Model.Count()</span>
                            <span class="resumen-label">Servicios</span>
                        </div>
                        <div class="resumen-item">
                            <span class="resumen-valor">@Model.Sum(x => x.Cantidad)</span>
                            <span class="resumen-label">Total Unidades</span>
                        </div>
                        <div class="total-carrito">
                            <span class="resumen-valor">S/ @totalPagar.ToString("N2")</span>
                            <span class="resumen-label">Total a Pagar</span>
                        </div>
                    </div>
                }
                else
                {
                    <div class="estado-vacio">
                        <div class="vacio-icono">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h5>Carrito Vacío</h5>
                        <p>No hay servicios en el carrito.</p>
                        <a asp-controller="Servicio" asp-action="Servicios" class="btn-agregar-servicios">
                            <i class="fas fa-plus-circle me-2"></i>
                            Explorar Servicios
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/RegistrarPedido.js"></script>
}